# ARMv8 Smart Speaker

Система распознавания голоса для ARMv8-устройств (Orange Pi 5 Pro, Raspberry Pi и др.) на базе Debian с использованием Vosk STT.

## Возможности

- Запись звука с микрофона через WebSocket
- Детектирование голосовой активности (VAD) для лучшего распознавания
- Распознавание речи с помощью модели Vosk
- Передача аудио и текста через WebSockets
- Автоматическое управление виртуальным окружением
- Оптимизирован для работы на ARMv8 архитектуре

## Компоненты

Система состоит из трех основных компонентов:

1. **mic.py** - Микрофонный сервис, записывает аудио и транслирует его через WebSocket
2. **stt.py** - Сервис распознавания речи, получает аудио от mic.py и преобразует его в текст
3. **main.py** - Основной контроллер, запускает и координирует все сервисы

Также имеется удобный скрипт запуска:
- **run.py** - Проверяет окружение, зависимости и запускает систему

## Установка

### Требования
- Python 3.7+
- Debian/Ubuntu на устройстве ARMv8 (aarch64)
- ALSA для работы с аудио
- Модель Vosk для русской речи

### Установка зависимостей системы
```bash
sudo apt update
sudo apt install -y python3-venv python3-dev portaudio19-dev libatlas-base-dev
```

### Настройка Python окружения
Автоматически через run.py:
```bash
python3 run.py
```
Ручная настройка:
```bash
# Создание виртуального окружения
python3 -m venv venv
source venv/bin/activate  # Linux
venv\Scripts\activate     # Windows

# Установка зависимостей
pip install --upgrade pip
pip install -r requirements.txt
```

### Загрузка модели Vosk
Если модель еще не загружена:

```bash
mkdir -p models
cd models
wget https://alphacephei.com/vosk/models/vosk-model-small-ru-0.22.zip
unzip vosk-model-small-ru-0.22.zip
cd ..
```

## Использование

### Запуск через скрипт run.py (рекомендуется)
```bash
# Базовый запуск
python run.py

# Запуск с аргументами
python run.py --device 1 --debug
```

### Запуск через основной контроллер
```bash
# Активация venv
source venv/bin/activate  # Linux
venv\Scripts\activate     # Windows

# Базовый запуск
python main.py

# Для просмотра доступных аудио устройств
python main.py --list-devices

# Запуск с указанием устройства и портов
python main.py --device 1 --mic-port 8765 --stt-port 8778
```

### Запуск компонентов по отдельности
Если нужно запустить сервисы независимо:

```bash
# Активация venv
source venv/bin/activate  # Linux
venv\Scripts\activate     # Windows

# Микрофонный сервис
python mic.py --device 0 --port 8765 --vad-mode 3

# Сервис STT
python stt.py --model models/vosk-model-small-ru-0.22 --mic-uri ws://localhost:8765
```

## Настройка для Orange Pi 5 Pro

### Настройка ALSA
```bash
# Установка ALSA утилит
sudo apt install alsa-utils

# Настройка аудиоустройств
alsamixer

# Проверка микрофонов
arecord -l
```

### Разрешения для аудио
```bash
# Добавьте пользователя в audio группу
sudo usermod -a -G audio $USER
# Перезагрузка или выход/вход в систему для применения изменений
```

## Особенности и улучшения

### Voice Activity Detection (VAD)
Система использует WebRTC VAD для определения голосовой активности. Это позволяет:
- Экономить ресурсы процессора, обрабатывая только речь
- Повысить точность распознавания за счет фильтрации шумов
- Снизить нагрузку на сеть, передавая только значимые аудиоданные

Настройки VAD можно менять через параметр `--vad-mode`:
```bash
# VAD с более высокой чувствительностью (меньше пропусков, больше ложных срабатываний)
python mic.py --vad-mode 1

# VAD с более высокой агрессивностью (меньше ложных срабатываний, риск пропуска речи)
python mic.py --vad-mode 3
```

### Переподключение и надежность
Система включает:
- Автоматическое переподключение при обрыве связи с экспоненциальной задержкой
- Мониторинг и автоматический перезапуск сервисов
- Обработку ошибок и плавное восстановление

### Конфигурация через .env
Можно настроить систему через файл .env:
```
# .env пример
MIC_WS_PORT=8765
STT_WS_PORT=8778
VOSK_MODEL_PATH=models/vosk-model-small-ru-0.22
VAD_MODE=3
DEBUG=false
```

## Решение проблем

### Не удается найти микрофон
```bash
# Проверьте доступные устройства
python run.py --list-devices

# Или напрямую через ALSA
arecord -l
```

### Проблемы с распознаванием речи
```bash
# Проверьте наличие модели Vosk
ls -la models/vosk-model-small-ru-0.22

# Запустите с отладкой
python run.py --debug
```

### Ручной перезапуск сервисов
Если сервисы зависли или работают некорректно:
```bash
# Ctrl+C для остановки
# Затем запустите снова
python run.py
```

## Развитие проекта

Будущие улучшения могут включать:
- Интеграцию с более продвинутыми системами распознавания речи
- Добавление системы синтеза речи для ответов
- Управление умным домом через голосовые команды
- Многоязычную поддержку

